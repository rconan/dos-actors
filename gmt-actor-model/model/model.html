<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Model - GMT DOS ACTORS</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/gmt-actor-model.html"><strong aria-hidden="true">1.</strong> GMT Actors Model</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../gmt-actor-model/actors/actors.html"><strong aria-hidden="true">1.1.</strong> Actors</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/data/data.html"><strong aria-hidden="true">1.2.</strong> Data</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/model/model.html" class="active"><strong aria-hidden="true">1.3.</strong> Model</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/clients/client.html"><strong aria-hidden="true">1.4.</strong> Clients</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../gmt-actor-model/clients/sig-log/sig-log.html"><strong aria-hidden="true">1.4.1.</strong> Signals & Logger</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/clients/feedback/feedback.html"><strong aria-hidden="true">1.4.2.</strong> Feedback System</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/clients/multirate/multirate.html"><strong aria-hidden="true">1.4.3.</strong> Multirate System</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/clients/persistence/persistence.html"><strong aria-hidden="true">1.4.4.</strong> Persistence</a></li></ol></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/aggregation/aggregation.html"><strong aria-hidden="true">1.5.</strong> Aggregation</a></li><li class="chapter-item expanded "><a href="../../gmt-actor-model/correctness/correctness.html"><strong aria-hidden="true">1.6.</strong> Correctness</a></li></ol></li><li class="chapter-item expanded "><a href="../../grim/grim.html"><strong aria-hidden="true">2.</strong> GRISM</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../grim/io/io.html"><strong aria-hidden="true">2.1.</strong> IO</a></li><li class="chapter-item expanded "><a href="../../grim/arrow/arrow.html"><strong aria-hidden="true">2.2.</strong> ARROW</a></li><li class="chapter-item expanded "><a href="../../grim/fem/fem.html"><strong aria-hidden="true">2.3.</strong> FEM</a></li><li class="chapter-item expanded "><a href="../../grim/control/control.html"><strong aria-hidden="true">2.4.</strong> Control</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../grim/control/mount/mount.html"><strong aria-hidden="true">2.4.1.</strong> Mount</a></li><li class="chapter-item expanded "><a href="../../grim/control/m1/m1.html"><strong aria-hidden="true">2.4.2.</strong> M1</a></li><li class="chapter-item expanded "><a href="../../grim/control/m2/m2.html"><strong aria-hidden="true">2.4.3.</strong> M2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../grim/control/m2/fsm/fsm.html"><strong aria-hidden="true">2.4.3.1.</strong> FSM</a></li><li class="chapter-item expanded "><a href="../../grim/control/m2/asm/asm.html"><strong aria-hidden="true">2.4.3.2.</strong> ASM</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GMT DOS ACTORS</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rconan/dos-actors/tree/main/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rconan/dos-actors/edit/main/book/src/gmt-actor-model/model/model.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="model"><a class="header" href="#model">Model</a></h1>
<p>A model is a network of clients connected to each other by pairs of output/input.
The actor/client interfaces specify the tasks that are going to be executed and the topology of the network defines the order in which the tasks are executed.</p>
<p>A pair of output/input defines a unique <a href="https://docs.rs/flume/latest/flume/">channel</a>  with a sender and a receiver.
The sender is given to the output and the receiver to the input. </p>
<p>Each actor performs the following task sequentially in a never ending inner loop and asynchronously with respect to the other actors :</p>
<ol>
<li>if any inputs, receive inputs &amp; invoke client <code>gmt_dos_actors::io::Read</code> trait implementation on each input,</li>
<li>update client state with the client <code>gmt_dos_actors::io::Update</code> trait implementation,</li>
<li>if any outputs, invoke the client <code>gmt_dos_actors::io::Write</code> trait implementation on each output &amp; send outputs.</li>
</ol>
<p>The default behavior of an actor is to pause the inner loop both until all the inputs have been received and until all the outputs have been received by other actors.</p>
<p><img src="model.svg" alt="Model" /></p>
<p>In the model above, the network topology imposes the following sequence of events (from top to bottom):</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: right"></th><th>A</th><th>B</th><th>C</th><th>D</th></tr></thead><tbody>
<tr><td style="text-align: right">1</td><td><code>Update</code></td><td>-</td><td>-</td><td>-</td></tr>
<tr><td style="text-align: right">2</td><td><code>Write::&lt;AB,ABC&gt;</code></td><td>-</td><td>-</td><td>-</td></tr>
<tr><td style="text-align: right">3</td><td>-</td><td><code>Read::&lt;AB,ABC&gt;</code></td><td><code>Read::&lt;ABC&gt;</code></td><td>-</td></tr>
<tr><td style="text-align: right">4</td><td><code>Update</code></td><td>-</td><td><code>Update</code></td><td>-</td></tr>
<tr><td style="text-align: right">5</td><td><code>Write::&lt;AB,ABC&gt;</code></td><td>-</td><td><code>Write::&lt;CB,CD&gt;</code></td><td>-</td></tr>
<tr><td style="text-align: right">6</td><td>-</td><td><code>Read::&lt;CB&gt;</code></td><td>-</td><td><code>Read::&lt;CD&gt;</code></td></tr>
<tr><td style="text-align: right">7</td><td>-</td><td><code>Update</code></td><td><code>Read::&lt;ABC&gt;</code></td><td>-</td></tr>
<tr><td style="text-align: right">8</td><td>-</td><td><code>Write::&lt;BD1,BD2&gt;</code></td><td><code>Update</code></td><td>-</td></tr>
<tr><td style="text-align: right">9</td><td>-</td><td>-</td><td><code>Write::&lt;CB,CD&gt;</code></td><td><code>Read::&lt;BD1,BD2&gt;</code></td></tr>
<tr><td style="text-align: right">10</td><td>-</td><td><code>Read::&lt;AB,ABC,CB&gt;</code></td><td>-</td><td><code>Update</code></td></tr>
<tr><td style="text-align: right">11</td><td><code>Update</code></td><td><code>Update</code></td><td>-</td><td><code>Read::&lt;CD&gt;</code></td></tr>
<tr><td style="text-align: right">12</td><td>...</td><td></td><td></td><td></td></tr>
</tbody></table>
</div>
<p>Note that events in the same row may occur simultaneously thanks to the asynchronous nature of the actors.</p>
<p>Laying out the network consists in building actors outputs and relaying them to other actors inputs.
A pair of output and input must meet the following requirements:</p>
<ul>
<li>the client of the output actor must implement the trait <code>gmt_dos_actors::io::Write&lt;I&gt;</code></li>
<li>the client of the input actor must implement the trait <code>gmt_dos_actors::io::Read&lt;O&gt;</code></li>
<li><code>I</code> and <code>O</code> must be of the same type i.e. <code>I=O</code></li>
<li>the ouput rate <code>NO</code> must be equal to the input rate <code>NI</code> (<code>NO=NI</code>)</li>
</ul>
<p>A model will not compile in any of the above requirements is not met.</p>
<p>For client <code>A</code> that gives:</p>
<pre><code class="language-rust no_run noplayground">A.add_output().build::&lt;AB&gt;().into_input(&amp;mut B);
A.add_output().multiplex(2).build::&lt;ABC&gt;()
   .into_input(&amp;mut B)
   .into_input(&amp;mut C);</code></pre>
<p>As illustrated above, an output can be multiplexed and sent to multiple inputs.</p>
<p>Then for <code>B</code>:</p>
<pre><code class="language-rust no_run noplayground">B.add_output().build::&lt;BD1&gt;().into_input(&amp;mut D);
B.add_output().build::&lt;BD2&gt;().into_input(&amp;mut D);</code></pre>
<p>and <code>C</code> :</p>
<pre><code class="language-rust no_run noplayground">C.add_output().build::&lt;CB&gt;().into_input(&amp;mut B);
C.add_output().build::&lt;CD&gt;().into_input(&amp;mut D);</code></pre>
<p>Per default, an actor inner loop is blocked until all its outputs have been read by the associated inputs as a guarantee that the data has been effectively received.</p>
<p>This is not always necessary, particulary for a client that acts as a data sink like <code>D</code>.
The links to <code>D</code> can be rewritten:</p>
<pre><code class="language-rust no_run noplayground">B.add_output().unbounded().build::&lt;BD1&gt;().into_input(&amp;mut D);
B.add_output().unbounded().build::&lt;BD2&gt;().into_input(&amp;mut D);
C.add_output().unbounded().build::&lt;CD&gt;().into_input(&amp;mut D);</code></pre>
<p>and the outputs <code>BD1</code>, <code>BD2</code> and <code>CD</code> won't block their actors inner loop anymore.</p>
<p>Once all the connections have been set-up, we can assemble the actors into a model:</p>
<pre><code class="language-rust no_run noplayground">let mut model = Model::new(vec![Box::new(A),Box::new(B),Box::new(C),Box::new(D)]);</code></pre>
<p>check the model for errors, run it and wait for it to finish:</p>
<pre><code class="language-rust no_run noplayground">model.check()?.run().await?;</code></pre>
<p>Note that the <code>run</code> method cannot be invoked on an unchecked model.
The methods that can be called upon <a href="https://docs.rs/gmt_dos-actors/latest/gmt_dos_actors/model/struct.Model.html"><code>Model</code></a> depend on the value of the <code>Model</code> <code>State</code> generic type parameter.
Some method performs a state transition giving access to other methods.</p>
<p>The model <code>State</code> table shows from which state a <code>Model</code> method is called and in which state the model is transitioned to:</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>From</th><th>To</th></tr></thead><tbody>
<tr><td><code>Model::new</code></td><td><code>Unknown</code></td><td><code>Unknown</code></td></tr>
<tr><td><code>Model::check</code></td><td><code>Unknown</code></td><td><code>Ready</code></td></tr>
<tr><td><code>Model::run</code></td><td><code>Ready</code></td><td><code>Running</code></td></tr>
<tr><td><code>Model::await</code></td><td><code>Running</code></td><td><code>Completed</code></td></tr>
<tr><td><code>Model::name</code></td><td><code>Unknown</code></td><td><code>Unknown</code></td></tr>
<tr><td><code>Model::add</code></td><td><code>Unknown</code></td><td><code>Unknown</code></td></tr>
<tr><td><code>Model::flowchart</code></td><td><code>Unknown</code></td><td><code>Unknown</code></td></tr>
<tr><td><code>Model::flowchart</code></td><td><code>Ready</code></td><td><code>Ready</code></td></tr>
</tbody></table>
</div>
<p>A flow chart of the model can be obtained with the <code>flowchart</code> method.
Each client is identified by either its type or the actor's name if one was given.
Combining all the <code>Model</code> methods in a single call gives:</p>
<pre><code class="language-rust no_run noplayground">Model::new(vec![Box::new(A),
               Box::new(B),
               Box::new(C),
               Box::new(D)])
   .flowchart()
   .check()?
   .run()
   .await?;</code></pre>
<p>The flowchart is written to the file <code>integrated_model.dot.svg</code>.</p>
<p>The boilerplate code used for model declaration: </p>
<pre><code class="language-rust no_run noplayground">Model::new(vec![Box::new(...),vec![Box::new(...),...])</code></pre>
<p>can be advantageously replaced with the Rust macro <code>model!</code>, e.g.</p>
<pre><code class="language-rust no_run noplayground">model!(A,B,C,D)
   .flowchart()
   .check()?
   .run()
   .await?;</code></pre>
<p>When an output detects that the data the client has written to its buffer is <code>None</code>, it closes the channel it belongs to and return an error to the actor that forces the actor to shut down.</p>
<p>When an actor shuts down its inputs and outputs close the channels they are part of.
A closed channel also generates an error that is caught by the actors at both end of the channel and forces these actors to also shut down and so, by a domino effect, all the actors are terminated and the model gracefully comes to an end.</p>
<h2 id="working-example"><a class="header" href="#working-example">Working example</a></h2>
<p>Building upon the example in the previous section, lets add 2 more clients:</p>
<ul>
<li>a random generator</li>
</ul>
<pre><code class="language-rust no_run noplayground">struct RandGen {
    data: Vec&lt;i32&gt;,
}
impl RandGen {
    pub fn new(n_sample: usize) -&gt; Self {
        let mut data = vec![0i32; n_sample];
        let mut rng = WyRand::new();
        rng.fill(&amp;mut data);
        Self { data }
    }
}
impl Update for RandGen {}
impl Write&lt;In&gt; for RandGen {
    fn write(&amp;mut self) -&gt; Option&lt;Data&lt;In&gt;&gt; {
        self.data.pop().map(|val| Data::new(val))
    }
}</code></pre>
<ul>
<li>a data logger</li>
</ul>
<pre><code class="language-rust no_run noplayground">#[derive(Default)]
struct DataLogger {
    data: Vec&lt;f32&gt;,
}
impl Update for DataLogger {}
impl Read&lt;Out&gt; for DataLogger {
    fn read(&amp;mut self, data: Data&lt;Out&gt;) {
        self.data.push(*data);
    }
}</code></pre>
<p>With all the clients defined with an actor/client interface, the actors are instanciated with</p>
<pre><code class="language-rust no_run noplayground">    let mut source = Initiator::&lt;_&gt;::from(RandGen::new(1_000_000));
    let mut filter = Actor::&lt;_&gt;::from(Client::default());
    let mut log = Terminator::&lt;_&gt;::from(DataLogger::default());</code></pre>
<p>Each actor requires 3 generic type parameters: the client type and 2 constants: the inputs and outputs sampling rates.
The inputs rate is zero if the actor has no inputs and the outputs rate is zero if the actor has no outputs.
The default sampling rate for inputs and outputs is 1.</p>
<p>The next step is to build the network. The links between actors are established by successively creating channels between an actor output and the input of another actor, both the output and the input must have been given the same type and the same sampling rate. </p>
<pre><code class="language-rust no_run noplayground">    source.add_output().build::&lt;In&gt;().into_input(&amp;mut filter)?;
    filter
        .add_output()
        .unbounded()
        .build::&lt;Out&gt;()
        .into_input(&amp;mut log)?;</code></pre>
<p>Now the model can be assembled, charted, checked for errors and run:</p>
<pre><code class="language-rust no_run noplayground">    model!(source, filter, log)
        .flowchart()
        .check()?
        .run()
        .await?;</code></pre>
<p><img src="integrated_model.dot.svg" alt="Integrated Model" /></p>
<p>The model stop itself when the data from the <code>RandGen</code> client is exhausted.</p>
<p>By setting a <a href="https://docs.rs/log/">logger</a> at the begining of the main application, insight into the behavior of the model can be gathered.
For example, setting the <a href="https://docs.rs/env_logger/">env_logger</a> crate with </p>
<pre><code class="language-rust no_run noplayground">    env_logger::builder()
        .format_timestamp(None)
        .format_target(false)
        .init();</code></pre>
<p>and running the application with the <code>RUST_LOG</code> environment variable:</p>
<pre><code>RUST_LOG=warn cargo run ... 
</code></pre>
<p>outputs the following:</p>
<p><img src="model_warn.png" alt="Warning" /></p>
<p>Setting  <code>RUST_LOG</code> to <code>info</code> instead gives</p>
<pre><code>RUST_LOG=info cargo run ... 
</code></pre>
<p><img src="model_info.png" alt="Warning" /></p>
<p>and with </p>
<pre><code>RUST_LOG=debug cargo run ... 
</code></pre>
<p><img src="model_debug.png" alt="Warning" /></p>
<p>Debug information is displayed only for application run in debug mode.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../gmt-actor-model/data/data.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../gmt-actor-model/clients/client.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../gmt-actor-model/data/data.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../gmt-actor-model/clients/client.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
